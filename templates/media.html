<!DOCTYPE html>
<html>
<head>
    <script src="{{ url_for('static', filename='helper.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}"></link>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.3/socket.io.js"></script>
    <script type="text/javascript">
        var idx = "{{ idx }}"
        var dbId = "{{ db_id }}"
        var checkedTagIds = "{{ checked_tag_ids }}".split(' ')
        var socket = io.connect('http://' + document.domain + ':' + location.port);

        socket.on('connect', function () {
            console.log('Connected to the server');
        });

        socket.on('response', function (data) {
            console.log('Server says: ' + data);
        });

        socket.on('set_asset_' + dbId + '_attribute', function (data) {
            console.log('Server says: ' + data);
            document.getElementById(data['attribute']).checked = data['value'];
        });

        function handleSetAssetBoolean(checkbox, attribute) {
            socket.emit('set_asset_boolean', { db_id: dbId, attribute, value: checkbox.checked });
        }

        function handleTagClicked(checkbox, isMultiselect) {
            socket.emit('set_tag', {
                db_id: dbId,
                tag_id: checkbox.id,
                value: checkbox.checked,
                tag_group_id: checkbox.name,
                is_multiselect: isMultiselect
            });
        }

        function makeSelectedVisible(checkboxElement) {
            if (checkboxElement && checkboxElement.checked) {
                checkboxElement.scrollIntoView({
                    behavior: 'smooth', // Optional: provides a smooth scrolling animation
                    block: 'nearest'    // Scrolls to the nearest edge of the container
                });
                return true;
            }
            return false;
        }

        document.addEventListener('DOMContentLoaded', function() {
            for (const checkedTag of checkedTagIds) {
                const checkbox = document.getElementById(checkedTag);
                makeSelectedVisible(checkbox);
            }
        });
    </script>
    {% if idx > 0 %}
    <script>
      window.previous_media = "{{ url_for('show_media', idx=idx-1) }}";
    </script>
    {% endif %}
    {% if idx + 1 < total %}
    <script>
      window.next_media = "{{ url_for('show_media', idx=idx+1) }}";
    </script>
    {% endif %}
</head>
<body>
    <div class="box">
        <div class="view">
            <h3>{{ filename }} ({{ filesize }} MB)</h3>
            {% if media_type == 'mp4' %}
            <video width="854" height="480" controls autoplay> 
                <source src="{{ url_for('send_media', idx=idx) }}" type="video/mp4" /> 
            </video>
            {% elif media_type == 'mp3' or media_type == 'ogg' %}
            <audio controls autoplay src="{{ url_for('send_media', idx=idx) }}"></audio>
            {% elif media_type == 'jpg' %}
            <img src="{{ url_for('send_media', idx=idx) }}" /> 
            {% endif %}
            <br/>
            {% if idx > 0 %}
                <a href="{{ url_for('show_media', idx=idx-1) }}">Prev</a>
            {% endif %}
            {% if idx + 1 < total %}
                <a href="{{ url_for('show_media', idx=idx+1) }}">Next</a>
            {% endif %}
            &nbsp;&nbsp;<a href="{{ url_for('show_media', idx='random') }}">Random</a>
            <p/>
            <a href="{{ url_for('list_media') }}#{{ idx }}">Back to list</a>
        </div>
        <div class="controls">
            <div>
                <label>
                    <input type="checkbox" id="favorite"
                    {% if favorite %} checked {% endif %}
                    onclick="handleSetAssetBoolean(this, 'favorite')">Favorite</input>
                </label>
                <br/>
                <label>
                    <input type="checkbox" id="bookmark"
                    {% if bookmark %} checked {% endif %}
                    onclick="handleSetAssetBoolean(this, 'bookmark')">Bookmark</input>
                </label>
                <br/>
                <label>
                    <input type="checkbox" id="should_delete"
                    {% if should_delete %} checked {% endif %}
                    onclick="handleSetAssetBoolean(this, 'should_delete')">Should delete</input>
                </label>
            </div>
            <p/>
            <div>
            {% for tg in tag_groups %}
                <fieldset class="tag-group">
                    <legend><b>{{ tg.name }}</b></legend>
                    <div class="scroll-box scroll-box-{{ tg.show_size }}">
                    {% for tag in tg.tags %}
                        {% if not tg.multiselect or tg.tag_per_line %}<div>{% endif %}
                        <label for="{{ tag.id }}" class="inline-label">
                        {% if tg.multiselect %}
                            <input type="checkbox" id="{{ tag.id }}" name="{{ tg.id }}"
                            {% if tag.id in tag_ids %}checked{% endif %}
                            onclick="handleTagClicked(this, true)" />
                        {% else %}
                            <input type="radio" id="{{ tag.id }}" name="{{ tg.id }}" value="{{ tag.id }}"
                            {% if tag.id in tag_ids %}checked{% endif %}
                            onclick="handleTagClicked(this, false)" />
                        {% endif %}
                            {{ tag.name }}
                        </label>
                        {% if not tg.multiselect or tg.tag_per_line %}</div>{% endif %}
                    {% endfor %}
                    </div>
                {% if tg.ui_addable %}
                <div class="add-tag">
                    <form action="{{ url_for('handle_add_tag') }}" method="POST">
                        <input type="text" id="add_tag" name="name" required />
                        <input type="hidden" name="db_id" value="{{ db_id }}">
                        <input type="hidden" name="idx" value="{{ idx }}">
                        <input type="hidden" name="tag_group_id" value="{{ tg.id }}">
                        <input type="submit" value="Add tag">
                    </form>
                </div>
                {% endif %}
                </fieldset>
            {% endfor %}
            </div>
        </div>
    </div>
</body>
</html>
